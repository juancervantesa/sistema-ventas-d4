name: Deploy to Self-Hosted Production

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: self-hosted
    env:
      DEPLOY_PATH: /var/www/sistema-ventas
      PHP_VERSION: 8.2 # Ajusta esto a tu versión de PHP real en el server

    steps:
    - name: Get current date
      id: date
      run: echo "date=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

    - name: Define Release Path
      run: echo "RELEASE_PATH=${{ env.DEPLOY_PATH }}/releases/${{ steps.date.outputs.date }}" >> $GITHUB_ENV

    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Release Directory
      run: |
        mkdir -p ${{ env.RELEASE_PATH }}
        # Copiamos todo el código fuente al directorio de release
        cp -r . ${{ env.RELEASE_PATH }}

    - name: Install PHP Dependencies
      run: |
        cd ${{ env.RELEASE_PATH }}
        composer install --no-dev --optimize-autoloader --no-interaction

    - name: Install Node Dependencies & Build
      run: |
        cd ${{ env.RELEASE_PATH }}
        npm ci
        npm run build
        rm -rf node_modules

    - name: Link Shared Resources
      run: |
        cd ${{ env.RELEASE_PATH }}
        rm -f .env
        ln -sf ${{ env.DEPLOY_PATH }}/shared/.env .env
        rm -rf storage
        ln -sf ${{ env.DEPLOY_PATH }}/shared/storage storage
        
        # Crear enlace a public/storage si no existe en shared
        cd ${{ env.DEPLOY_PATH }}/shared/storage
        mkdir -p app/public framework/cache framework/sessions framework/views framework/testing
        cd ${{ env.RELEASE_PATH }}
        php artisan storage:link

    - name: Run Migrations
      run: |
        cd ${{ env.RELEASE_PATH }}
        php artisan migrate --force

    - name: Optimize Application
      run: |
        cd ${{ env.RELEASE_PATH }}
        php artisan config:cache
        php artisan route:cache
        php artisan view:cache

    - name: Activate New Release (Atomic Switch)
      run: |
        ln -sfn ${{ env.RELEASE_PATH }} ${{ env.DEPLOY_PATH }}/current
        
        # Limpiar releases antiguos (mantener los 5 más recientes)
        cd ${{ env.DEPLOY_PATH }}/releases
        ls -dt * | tail -n +6 | xargs -d '\n' rm -rf || true

    - name: Reload Services
      run: |
        # Esto requiere que el usuario del runner tenga permisos sudo NOPASSWD para estos comandos
        # Si falla, no detiene el deploy, pero el servicio podría no tomar los cambios inmediatamente
        sudo systemctl reload php${{ env.PHP_VERSION }}-fpm || echo "Warning: Could not reload PHP-FPM"
        sudo systemctl reload nginx || echo "Warning: Could not reload Nginx"
        
        # Reiniciar colas si usas Supervisor
        # php artisan queue:restart
