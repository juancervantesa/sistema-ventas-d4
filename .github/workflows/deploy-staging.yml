name: Deploy to Staging

on:
  # Trigger after successful build on main
  workflow_run:
    workflows: ["Build & Release"]
    types: [completed]
    branches: [main]

  # Manual trigger
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Release tag to deploy (e.g., v1.0.0-develop-20260114-164500)"
        required: true

concurrency:
  group: deploy-staging
  cancel-in-progress: false

env:
  ENVIRONMENT: staging
  HEALTH_CHECK_TIMEOUT: 30

jobs:
  deploy:
    name: Deploy to Staging
    runs-on: self-hosted
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main')
    env:
      DEPLOY_PATH: ${{ secrets.STAGING_PATH }}
      RELEASE_URL: ${{ secrets.STAGING_URL }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Get Release Tag
        id: release
        run: |
          if [ -n "${{ github.event.inputs.release_tag }}" ]; then
            RELEASE_TAG="${{ github.event.inputs.release_tag }}"
          else
            # Get latest release from main
            RELEASE_TAG=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/releases?per_page=20" \
              | jq -r '.[] | select(.tag_name | contains("develop") | not) | .tag_name' \
              | head -1)
            if [ -z "$RELEASE_TAG" ]; then
              echo "No release found for main branch"
              exit 1
            fi
          fi
          echo "release_tag=${RELEASE_TAG}" >> $GITHUB_OUTPUT
          echo "Deploying release: ${RELEASE_TAG}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Display Deployment Info
        run: |
          echo "## Staging Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Release** | \`${{ steps.release.outputs.release_tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | staging (self-hosted) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Triggered by** | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY

      # Pre-deploy checks (Local Shell)
      - name: Pre-Deploy Checks
        run: |
          set -e
          echo "Running pre-deploy checks..."

          # Check disk space
          AVAILABLE=$(df -BG "$DEPLOY_PATH" | awk 'NR==2 {print $4}' | sed 's/G//')
          if [ "$AVAILABLE" -lt 1 ]; then
            echo "Insufficient disk space: ${AVAILABLE}GB (need 1GB)"
            exit 1
          fi
          echo "Disk space: ${AVAILABLE}GB available"

          # Check shared directory
          if [ ! -d "$DEPLOY_PATH/shared" ]; then
            echo "Shared directory not found at $DEPLOY_PATH/shared"
            exit 1
          fi

          # Check .env
          if [ ! -f "$DEPLOY_PATH/shared/.env" ]; then
            echo ".env file not found"
            exit 1
          fi

          echo "All pre-deploy checks passed"

      # Deploy Application (Local Shell)
      - name: Deploy Application
        run: |
          set -e
          cd "$DEPLOY_PATH"

          RELEASE_TAG="${{ steps.release.outputs.release_tag }}"
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          RELEASE_DIR="releases/${TIMESTAMP}"

          echo "Downloading release: ${RELEASE_TAG}"

          # Download artifact
          ARTIFACT_NAME="sistema-ventas-${RELEASE_TAG}"
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/${RELEASE_TAG}/${ARTIFACT_NAME}.tar.gz"

          # Crear temp dir con permisos del usuario actual
          mkdir -p "/tmp/deploy-${TIMESTAMP}"
          curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -fsSL -o "/tmp/deploy-${TIMESTAMP}/${ARTIFACT_NAME}.tar.gz" "$DOWNLOAD_URL"

          echo "Extracting to ${RELEASE_DIR}"
          mkdir -p "${RELEASE_DIR}"
          tar -xzf "/tmp/deploy-${TIMESTAMP}/${ARTIFACT_NAME}.tar.gz" -C "${RELEASE_DIR}"

          echo "Creating symlinks"
          rm -rf "${RELEASE_DIR}/storage"
          ln -sfn "$(pwd)/shared/storage" "${RELEASE_DIR}/storage"
          ln -sfn "$(pwd)/shared/.env" "${RELEASE_DIR}/.env"

          echo "Setting permissions (sudo required if different user)"
          # Ajustar permisos
          chmod -R 755 "${RELEASE_DIR}"
          chmod -R 775 shared/storage

          echo "Creating database backup"
          mkdir -p shared/database/backups
          if command -v pg_dump &> /dev/null; then
            source shared/.env
            if [ -n "$DB_PASSWORD" ]; then
                PGPASSWORD="$DB_PASSWORD" pg_dump -h "$DB_HOST" -U "$DB_USERNAME" -Fc "$DB_DATABASE" > "shared/database/backups/pre-${TIMESTAMP}.sql" 2>/dev/null || echo "Backup skipped"
            fi
          fi

          echo "Clearing Laravel caches"
          cd "${RELEASE_DIR}"
          # Eliminar cachÃ©s generados en el build (github runner paths)
          rm -f bootstrap/cache/*.php
          php artisan optimize:clear

          echo "Running migrations"
          php artisan migrate --force

          echo "Atomic switch"
          cd "$DEPLOY_PATH"
          ln -sfn "$(pwd)/${RELEASE_DIR}" current.new
          mv -Tf current.new current

          echo "Reloading services"
          # Requiere que el usuario 'jota' tenga permisos sudo para estos comandos
          sudo systemctl reload php8.2-fpm || echo "Warning: Could not reload PHP-FPM"
          sudo nginx -s reload || echo "Warning: Could not reload Nginx"
          
          echo "Cleanup"
          rm -rf "/tmp/deploy-${TIMESTAMP}"

          # Keep only last 3 releases
          cd releases
          ls -t | tail -n +4 | xargs -r rm -rf

          echo "Deployment complete"

      # Health check
      - name: Health Check
        run: |
          echo "Running health checks..."
          sleep 5

          HEALTH_URL="$RELEASE_URL/api/health"
          # Usamos curl directo
          RESPONSE=$(curl -s -w "\n%{http_code}" --max-time ${{ env.HEALTH_CHECK_TIMEOUT }} "$HEALTH_URL" || echo "000")
          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "HTTP Status: ${HTTP_CODE}"
          echo "Response: ${BODY}"

          if [ "$HTTP_CODE" != "200" ]; then
            echo "Health check failed!"
            echo "## Health Check Failed" >> $GITHUB_STEP_SUMMARY
            echo "HTTP Status: ${HTTP_CODE}" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "Health check passed"
          echo "## Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** $RELEASE_URL" >> $GITHUB_STEP_SUMMARY

      # Rollback on failure
      - name: Rollback on Failure
        if: failure()
        run: |
          cd "$DEPLOY_PATH"

          PREVIOUS=$(ls -t releases | sed -n '2p')
          if [ -n "$PREVIOUS" ]; then
            echo "Rolling back to: ${PREVIOUS}"
            ln -sfn "$(pwd)/releases/${PREVIOUS}" current.new
            mv -Tf current.new current
            
            sudo systemctl reload php8.2-fpm || true
            sudo nginx -s reload || true
            
            echo "Rollback complete"
          else
            echo "No previous release to rollback to"
          fi
